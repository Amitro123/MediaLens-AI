id: "scene_detection"
name: "Scene Detection & Cataloging"
description: "Detect and catalog distinct scenes from video"

system_prompt: |
  You are a professional video scene analyzer specializing in Hebrew content.
  
  Your task is to create a comprehensive scene catalog from video frames and transcription.
  
  Key responsibilities:
  1. Identify distinct scenes (location/setting changes, new characters, topic shifts)
  2. Extract character names from Hebrew dialogue when mentioned
  3. Provide rich visual descriptions
  4. Capture exact Hebrew dialogue per scene
  5. Detect mood and tone

user_prompt: |
  Project: {project_name}
  Video Duration: {duration_seconds} seconds
  Frames Analyzed: {num_frames}
  
  Full Transcription (Hebrew):
  {transcription}
  
  ---
  
  Create a detailed scene catalog as a JSON array.
  
  SCENE DEFINITION:
  A scene is a continuous segment with:
  - Same location/setting
  - Same group of characters
  - Same conversational topic/action
  
  CRITICAL OUTPUT RULES:
  1. Return ONLY raw JSON array - NO markdown code fences
  2. Start with [ and end with ]
  3. Do NOT wrap in ```json or ```
  
  REQUIRED FIELDS PER SCENE (ALL MANDATORY):
  {{
    "scene_number": 1,
    "timestamp": "MM:SS - MM:SS",
    "time_sec": 0.0,
    "location": "string",
    "visual_description": "string",
    "characters": ["name1", "name2"],
    "dialogue": "string",
    "mood_tone": "string",
    "keywords": ["keyword1", "keyword2"],
    "frame_path": "uploads/session_id/frames/frame_XXXX.jpg"
  }}
  
  FIELD SPECIFICATIONS:
  
  1. scene_number: Integer, sequential starting from 1
  
  2. timestamp: String in format "MM:SS - MM:SS" (e.g., "00:13 - 00:45")
  
  3. time_sec: Float, scene start time in seconds (e.g., 13.5)
     - CRITICAL: This MUST be present for video seeking
     - Calculate from timestamp
  
  4. location: String describing the setting
     - Examples: "Living room", "Park at night", "Office", "Sauna"
  
  5. visual_description: Detailed description including:
     - What people are wearing
     - Objects in the scene (furniture, props)
     - Lighting conditions
     - Actions happening
     - Minimum 2 sentences
  
  6. characters: Array of strings
     - Extract names from Hebrew dialogue if mentioned (e.g., "יצקו", "עצקו")
     - Otherwise use descriptive identifiers: "Man 1", "Woman 1", "Dog"
     - Be consistent across scenes (same person = same identifier)
  
  7. dialogue: String containing ONLY the Hebrew dialogue from this scene
     - Keep original Hebrew text exactly as transcribed
     - Include only dialogue within this scene's timeframe
     - If no dialogue, use empty string ""
  
  8. mood_tone: String describing emotional atmosphere
     - Examples: "Casual, conversational", "Tense, frustrated", "Calm, reflective"
  
  9. keywords: Array of 3-6 searchable keywords
     - Include: location type, activities, emotions, objects
     - Use English keywords for consistency
     - Examples: ["phone call", "living room", "frustrated", "magazine"]
  
  10. frame_path: String path to the representative frame image
      - CRITICAL: This MUST match the actual extracted frame filename
      - You have access to {num_frames} frames
      - Format: "uploads/{{session_id}}/frames/frame_XXXX_tYY.Ys.jpg"
      - The frame number (XXXX) corresponds to the scene number (0001, 0002, etc.)
      - Example: For scene 1 at 0.0s → "uploads/{{session_id}}/frames/frame_0001_t0.0s.jpg"
      - Example: For scene 3 at 32.5s → "uploads/{{session_id}}/frames/frame_0003_t32.5s.jpg"
  
  CHARACTER EXTRACTION RULES:
  - Listen for names in the Hebrew dialogue
  - Example: If dialogue contains "היי עצקו" → character is "עצקו"
  - Example: If dialogue contains "יצקו התנתקנו" → character is "יצקו"
  - If no names mentioned, use "Man 1", "Man 2", "Woman 1", etc.
  - Maintain consistency: if "Man 1" appears in scene 2, he should be "Man 1" in scene 5 too
  
  TIME_SEC CALCULATION:
  - Parse the timestamp field to get start time
  - Convert MM:SS to seconds
  - Example: "01:24" → 84.0 seconds
  - Example: "00:13" → 13.0 seconds
  
  EXAMPLE OUTPUT (REFERENCE FORMAT):
  [
    {{
      "scene_number": 1,
      "timestamp": "00:00 - 00:13",
      "time_sec": 0.0,
      "location": "Park at night",
      "visual_description": "A person walks a dog on a leash through a dimly lit park. Streetlights cast long shadows on the paved path. Tall trees are visible in the background. The person wears a dark jacket and jeans, walking at a leisurely pace.",
      "characters": ["Man 1", "Dog"],
      "dialogue": "אה, אה, אה, אה,",
      "mood_tone": "Quiet, everyday activity",
      "keywords": ["park", "night", "dog", "walking", "outdoors", "streetlights"],
      "frame_path": "uploads/{{session_id}}/frames/frame_0001_t0.0s.jpg"
    }},
    {{
      "scene_number": 2,
      "timestamp": "00:13 - 00:32",
      "time_sec": 13.0,
      "location": "Living room",
      "visual_description": "A man sits on a brown leather couch reading a magazine. He wears a white t-shirt and grey shorts. The room has warm lighting from a table lamp on the left. A coffee table in front holds a bowl of fruit. White walls with framed pictures are visible in the background.",
      "characters": ["יצקו"],
      "dialogue": "כן. היי, עצקו, מה קורה אחי? ככה הרבה זמן לחזורה. כן, סורי, אולי, עם דברים על הראש. מה, על מרצי תלדבר? מה, אתה עם הכלבה עכשיו? כן, אני מרדן, הטיול על לי, את יודעת. על מרצי תלדבר? עצקו?",
      "mood_tone": "Casual, conversational",
      "keywords": ["living room", "couch", "reading", "phone call", "indoor", "relaxed"],
      "frame_path": "uploads/{{session_id}}/frames/frame_0002_t13.0s.jpg"
    }}
  ]
  
  FINAL REMINDER:
  - Return ONLY the JSON array
  - NO markdown code fences (no ``` at start or end)
  - Start directly with [
  - End with ]
  - ALL 10 fields MUST be present in every scene
  - Ensure time_sec matches the timestamp
  - Ensure frame_path uses the pattern shown above

output_format: "json"
